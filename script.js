	let records = [];





// This function just updates the Data Last Refreshed date
function updateLastRefreshed() {
    fetch('qualys-cve-epss-data.csv')
        .then(response => response.text())
        .then(data => {
            const rows = data.split('\n');
            if (rows.length > 1) {
                const secondRowColumns = rows[1].split(',');
                const lastRefreshed = secondRowColumns[12];
                if (lastRefreshed) {
                    document.getElementById('lastRefreshedDisplay').textContent = "Source data last refreshed: " + lastRefreshed;
                } else {
                    console.log("No 'Last Refreshed' date found");
                }
            }
        })
        .catch(error => {
            console.error("There was an error fetching the CSV:", error);
        });
}










// Fetch the CSV data when the document loads
document.addEventListener('DOMContentLoaded', function() {
    fetch('qualys-cve-epss-data.csv')
        .then(response => response.text())
        .then(data => {
            const csvRows = data.split('\n');
            const headers = parseCSVRow(csvRows[0]);
            
            for(let i = 1; i < csvRows.length; i++) {
                const rowArray = parseCSVRow(csvRows[i]);
                let rowObject = {};
                for(let j = 0; j < headers.length; j++) {
                    rowObject[headers[j]] = rowArray[j];
                }
                records.push(rowObject);
            }
            
            console.log("Records loaded:", records);
			updateLastRefreshed();

        }); 
});



function parseCSVRow(row) {
    let cells = [];
    let inQuotes = false;
    let currentValue = '';

    for (let i = 0; i < row.length; i++) {
        const char = row[i];
        if (inQuotes) {
            if (char === '"' && row[i + 1] === '"') {  // Double quotes are treated as a single quote in CSV
                currentValue += '"';
                i++;  // Skip next quote
            } else if (char === '"') {  // End of quoted value
                inQuotes = false;
            } else {
                currentValue += char;
            }
        } else {
            if (char === '"') {
                inQuotes = true;
            } else if (char === ',') {
                cells.push(currentValue);
                currentValue = '';
            } else {
                currentValue += char;
            }
        }
    }

    cells.push(currentValue);  // Add the last value
    return cells;
}

function updateRowCount(tableId, count) {
    document.getElementById('row-count-display-qid').textContent = `Results: ${count}`;
    document.getElementById('row-count-display-cve').textContent = `Results: ${count}`;
    document.getElementById('row-count-display-cisakev').textContent = `Results: ${count}`;
}


function searchByQID() {
    clearAllResults();
    let qid = document.getElementById('qidSearch').value;
    console.log("Searching for QID:", qid);

    let matchedRecords = [];


		
    for(let record of records) {
        if (record["QID"] == qid) {
            matchedRecords.push(record);
        }
    }
	updateRowCount('row-count-display-qid', matchedRecords.length);	
    // Sort by CVE ID
    matchedRecords.sort((a, b) => {
        if (a["CVE"] < b["CVE"]) return -1;
        if (a["CVE"] > b["CVE"]) return 1;
        return 0;

    });

    // Clear previous results
    const tbody = document.getElementById('qid-result-tbody');
    tbody.innerHTML = "";

    if (matchedRecords.length) {
        for(let matchedRecord of matchedRecords) {
            let row = tbody.insertRow();

            // QID cell
            let cell = row.insertCell();
            cell.innerText = matchedRecord["QID"];

            // Qualys Vulnerability Title cell
            cell = row.insertCell();
            cell.innerText = matchedRecord["Qualys Vulnerability Title"];

            // Associated CVEs cell
            cell = row.insertCell();
            cell.innerText = matchedRecord["CVE"];
			
            // QVS cell
            cell = row.insertCell();
            cell.innerText = matchedRecord["QVS"] || "";  // Assuming the record might have a "QVS" field, and default to ""

            // EPSS Score cell
            cell = row.insertCell();
            cell.innerText = matchedRecord["EPSS"] || "";  // Display the EPSS associated with the specific CVE

            // CVSS baseScore cell
            cell = row.insertCell();
            cell.innerText = matchedRecord["CVSS baseScore"];

            // CVSS Version cell
            cell = row.insertCell();
            cell.innerText = matchedRecord["CVSS Version"];

            // CISA KEV
            cell = row.insertCell();
            cell.innerText = matchedRecord["CISA KEV"] || "";
			console.log(matchedRecord);
        }
	
        document.getElementById('qid-result').style.display = 'block';
    } else {
        tbody.innerHTML = "<tr><td colspan='7'>No results found for QID: " + qid + "</td></tr>";
    }
			// Clear the search input
			document.getElementById('qidSearch').value = '';
			document.getElementById('cveSearch').value = '';
			document.getElementById('cve-result').style.display = 'none';
}


function searchByCVE() {
    clearAllResults();
    let cve = document.getElementById('cveSearch').value;

    // Ensure "CVE-" prefix is present
    if (!cve.startsWith("CVE-")) {
        cve = "CVE-" + cve;
    }
    
    // Filter matching records for the given CVE
    let matchedRecords = records.filter(record => record["CVE"] == cve);

    // Clear previous results
    const tbody = document.getElementById('cve-result-tbody');
    tbody.innerHTML = "";

	updateRowCount('row-count-display-cve', matchedRecords.length);
		
    if (matchedRecords.length) {
        populateCVEtable(matchedRecords, tbody);
    } else {
        tbody.innerHTML = "<tr><td colspan='7'>No results found for CVE: " + cve + "</td></tr>";
    }

    document.getElementById('cve-result').style.display = 'block';
    document.getElementById('qidSearch').value = '';
    document.getElementById('cveSearch').value = '';
    document.getElementById('qid-result').style.display = 'none';
}

function populateCVEtable(records, tbody) {
    records.forEach(record => {
        let row = tbody.insertRow();

        // CVE cell
        let cell = row.insertCell();
        cell.innerText = record["CVE"];

        // QID cell
        cell = row.insertCell();
        cell.innerText = record["QID"];

        // Qualys Vulnerability Title cell
        cell = row.insertCell();
        cell.innerText = record["Qualys Vulnerability Title"];

        // QVS cell
        cell = row.insertCell();
        cell.innerText = record["QVS"] || "";

        // EPSS cell
        cell = row.insertCell();
        cell.innerText = record["EPSS"] || "";

        // CVSS Base cell
        cell = row.insertCell();
        cell.innerText = record["CVSS baseScore"];

        // CVSS3.1 Base cell
        cell = row.insertCell();
        cell.innerText = record["CVSS Version"];

		// CISA KEV
		cell = row.insertCell();
		cell.innerText = record["CISA KEV"] || "";
		
    });
}

function searchByCISAKEV() {
	clearAllResults();
    // Filter records for those with 'Yes' in the CISA KEV column
    let matchedRecords = records.filter(record => record["CISA KEV"] && record["CISA KEV"].trim().toLowerCase() === 'yes');

    // Get unique CVEs only
    let uniqueCVEs = [...new Map(matchedRecords.map(record => [record["CVE"], record])).values()];

	updateRowCount('row-count-display-cisakev', uniqueCVEs.length);
	
    // Clear previous results
    const tbody = document.getElementById('cisakev-result-tbody');
    tbody.innerHTML = '';
	


    if (uniqueCVEs.length) {
        populateCISAKEVtable(uniqueCVEs, tbody);
        document.getElementById('cisakev-result').style.display = 'block'; // Show the CISA KEV results
    } else {
        tbody.innerHTML = "<tr><td colspan='6'>No records found with 'Yes' in CISA KEV</td></tr>";
    }


}


function populateCISAKEVtable(records, tbody) {
    records.forEach(record => {
        let row = tbody.insertRow();

        // Add only specific cells for CVE, QVS, EPSS, CVSS baseScore, CVSS Version, and CISA KEV
        let cell = row.insertCell();
        cell.innerText = record["CVE"];
        cell = row.insertCell();
        cell.innerText = record["QVS"] || "";
        cell = row.insertCell();
        cell.innerText = record["EPSS"] || "";
        cell = row.insertCell();
        cell.innerText = record["CVSS baseScore"] || "";
        cell = row.insertCell();
        cell.innerText = record["CVSS Version"] || "";
        cell = row.insertCell();
        cell.innerText = record["CISA KEV"];
		

    });
}

let currentSort = {
    column: null,
    asc: true,
    table: null
};



function sortBy(column, isNumeric, tableId, columnHeaders) {
    const tbody = document.getElementById(tableId);
    const rows = Array.from(tbody.querySelectorAll(':scope > tr'));

    if (currentSort.column === column && currentSort.tableId === tableId) {
        currentSort.asc = !currentSort.asc;
    } else {
        currentSort.asc = true;
        currentSort.column = column;
        currentSort.tableId = tableId;
    }

    rows.sort((a, b) => {
        let valA = a.cells[columnHeaders[column]].innerText.trim();
        let valB = b.cells[columnHeaders[column]].innerText.trim();

        // Parse numbers if isNumeric is true
        if (isNumeric) {
            valA = valA === '-' ? 0 : parseFloat(valA.replace(/,/g, '')) || 0;
            valB = valB === '-' ? 0 : parseFloat(valB.replace(/,/g, '')) || 0;
        } else {
            valA = valA.toUpperCase(); // Ignore case for string comparison
            valB = valB.toUpperCase();
        }

        // Determine sort order
        if (valA < valB) return currentSort.asc ? -1 : 1;
        if (valA > valB) return currentSort.asc ? 1 : -1;
        return 0;
    });

    // Empty the tbody and re-append the sorted rows
    while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
    rows.forEach(row => tbody.appendChild(row));
}










// Attach event listeners to each header for sorting
document.getElementById("header-qid").addEventListener('click', () => sortBy('QID', false, 'qid-result-tbody',qidColumnHeaders));
document.getElementById("header-title").addEventListener('click', () => sortBy('Qualys Vulnerability Title', false, 'qid-result-tbody',qidColumnHeaders));
document.getElementById("header-cve").addEventListener('click', () => sortBy('CVE', false, 'qid-result-tbody',qidColumnHeaders));
document.getElementById("header-qvs").addEventListener('click', () => sortBy('QVS', true, 'qid-result-tbody',qidColumnHeaders));
document.getElementById("header-epss").addEventListener('click', () => sortBy('EPSS', true, 'qid-result-tbody',qidColumnHeaders));
document.getElementById("header-cvss").addEventListener('click', () => sortBy('CVSS baseScore', true, 'qid-result-tbody',qidColumnHeaders));
document.getElementById("header-cvss3").addEventListener('click', () => sortBy('CVSS Version', false, 'qid-result-tbody',qidColumnHeaders));

document.getElementById("header-qid").addEventListener('click', () => sortBy('QID', false, 'qid-result-tbody',cveColumnHeaders));
document.getElementById("header-title").addEventListener('click', () => sortBy('Qualys Vulnerability Title', false, 'qid-result-tbody',cveColumnHeaders));
document.getElementById("header-cve").addEventListener('click', () => sortBy('CVE', false, 'qid-result-tbody',cveColumnHeaders));
document.getElementById("header-qvs").addEventListener('click', () => sortBy('QVS', true, 'qid-result-tbody',cveColumnHeaders));
document.getElementById("header-epss").addEventListener('click', () => sortBy('EPSS', true, 'qid-result-tbody',cveColumnHeaders));
document.getElementById("header-cvss").addEventListener('click', () => sortBy('CVSS baseScore', true, 'qid-result-tbody',cveColumnHeaders));
document.getElementById("header-cvss3").addEventListener('click', () => sortBy('CVSS Version', false, 'qid-result-tbody',cveColumnHeaders));

document.getElementById("header-cve-cisakev").addEventListener('click', () => sortBy('CVE', false, 'cisakev-result-tbody',cisakevColumnHeaders));
document.getElementById("header-qvs-cisakev").addEventListener('click', () => sortBy('QVS', true, 'cisakev-result-tbody',cisakevColumnHeaders));
document.getElementById("header-epss-cisakev").addEventListener('click', () => sortBy('EPSS', true, 'cisakev-result-tbody',cisakevColumnHeaders));
document.getElementById("header-cvss-cisakev").addEventListener('click', () => sortBy('CVSS baseScore', true, 'cisakev-result-tbody',cisakevColumnHeaders));

function clearAllResults() {
    document.getElementById('qid-result-tbody').innerHTML = '';
    document.getElementById('cve-result-tbody').innerHTML = '';
    document.getElementById('cisakev-result-tbody').innerHTML = '';
    // Hide the result sections as well
    document.getElementById('qid-result').style.display = 'none';
    document.getElementById('cve-result').style.display = 'none';
    document.getElementById('cisakev-result').style.display = 'none';
}




const qidColumnHeaders = {
    'QID': 0,
    'Qualys Vulnerability Title': 1,
    'CVE': 2,
    'QVS': 3,
    'EPSS': 4,
    'CVSS baseScore': 5,
    'CVSS Version': 6,
    'CISA KEV': 7
};

const cveColumnHeaders = {
    'CVE': 0,
    'QID': 1,
    'Qualys Vulnerability Title': 2,
    'QVS': 3,
    'EPSS': 4,
    'CVSS baseScore': 5,
    'CVSS Version': 6,
    'CISA KEV': 7
};

const cisakevColumnHeaders = {
    'CVE': 0,
    'QVS': 1,
    'EPSS': 2,
    'CVSS baseScore': 3,
    'CVSS Version': 4,
    'CISA KEV': 5
};

